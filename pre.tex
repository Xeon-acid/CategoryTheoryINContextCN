\RequirePackage{etoolbox}



% XeLaTeX 基本设置
\RequirePackage{xeCJK}
% \RequirePackage{fontspec}

% 其他常用宏包
\RequirePackage{unicode-math}
% \def\vmathbb{\ }
% 设置西文和数学字体（必须在 unicode-math 之后）
\setmainfont{CMU Serif} % 设置西文主字体
\setmathfont{Latin Modern Math} % 设置数学字体，这是关键！
% \RequirePackage{amsmath, amssymb, amsthm}
\RequirePackage{amsthm}
% \RequirePackage{ntheorem}
\RequirePackage{geometry}
\RequirePackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    citecolor=blue,
    urlcolor=blue,
    pdfborder={0 0 0}
}
\RequirePackage{graphicx}
\RequirePackage{fancyhdr}
\RequirePackage{titlesec}
\RequirePackage{tocloft}
\RequirePackage{pgfplots}
\RequirePackage{indentfirst}
\RequirePackage{tikz}
\usetikzlibrary{cd}
\RequirePackage{pgffor}
% \RequirePackage{amsfonts}
\RequirePackage{footnote}
\RequirePackage{enumitem}
\RequirePackage{float}
\RequirePackage{extarrows}
% 页面设置
\geometry{a4paper, left=3cm, right=2.5cm, top=3cm, bottom=3cm}

% 页眉页脚设置
\pagestyle{fancy}
\fancyhf{} % 清除所有页眉页脚
\renewcommand{\headrulewidth}{0pt} % 页眉横线宽度
\renewcommand{\footrulewidth}{0pt}   % 页脚横线宽度（设为0表示无横线）


% 设置页眉
\fancyhead[RO]{\thepage}     % 单页右上：页码
\fancyhead[CO]{\leftmark}    % 单页中间：章节
\fancyhead[LE]{\thepage}     % 双页左上：页码  
\fancyhead[CE]{\rightmark}   % 双页中间：节

% 清空其他位置
\fancyhead[RE]{}
\fancyhead[LO]{}

% 设置章节标记格式
\renewcommand{\chaptermark}[1]{%
    \markboth{第 \arabic{chapter} 章\kern2em #1}{}
}
\renewcommand{\sectionmark}[1]{%
    \markright{第 \arabic{section}节\kern1em #1}
}


% 章节标题格式
\titleformat{\chapter}[hang]{\Huge\bfseries}{第\,\thechapter\,章}{2em}{}
\titleformat{\section}{\Large\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}{\large\bfseries}{\thesubsection}{1em}{}

% 目录设置
\renewcommand{\contentsname}{目录}
\setcounter{tocdepth}{2}

% 定理环境
\theoremstyle{definition}
\newtheorem{definition}{定义}[chapter]
\newtheorem{theorem}{定理}[chapter]

\newtheorem{proposition}{命题}[chapter]
% \renewtheorem{proof}{证明}[chapter]
\newtheorem{corollary}{推论}[chapter]
% \theoremstyle{remark}
\newtheorem{remark}{注解}[chapter]
% \theoremstyle{definition}
\newtheorem{example}{例}[chapter]
\theoremstyle{plain}
\newtheorem{lemma}{引理}[chapter]
\newcommand{\squarebrace}[1]{「#1」}
\renewcommand{\proofname}{\kern2em 证明}

\RequirePackage{needspace}
% 章节前言
\newenvironment{says}[3]
{
    \par\vspace{2em}
    \hfill%
    \begin{minipage}{.618\linewidth}
        \begin{flushleft}
            \begin{minipage}{\linewidth} % 添加内部minipage实现自动换行
                #1%
            \end{minipage}
        \end{flushleft}
        \hrule
        \begin{flushright}
            #2\cite{#3}%
        \end{flushright}
    \end{minipage}%
    \par\vspace{1em}
}{
}

% 如果你想用 \says{内容}{作者}{引用}，可以这样定义：
% \newcommand{\says}[3]{%
%   \begin{flushleft}#1\end{flushleft}%
%   \hrule
%   \begin{flushright}#2\cite{#3}\end{flushright}%
% }

% \newcommand{\myref}[1]{\S\arabic{chapter}.\arabic{section}~\ref{#1}}
% \RequirePackage{refcount}

\newcommand{\chptref}[1]{\S\,\ref*{#1}}

% MARK: 定义运算符列表

% \DeclareMathOperator{\tProj}{\Pi}
% \def\DclrMthOprLst{Ext,Hom,Mor,Ob,End,Aut}
% \typeout{DclrMthOprLst defined}
% \foreach \x in \DclrMthOprLst {%
%     \expandafter\global\expandafter\edef\csname\x\endcsname{%
%     \noexpand\mathop{\kern0pt \fam0 \x}%
% }
%     % \typeout{\x\space defined}%
% }
\ExplSyntaxOn
    \clist_set:Nn \l_tmpa_clist {Ext,Hom,Mor,Ob,End,Aut}
    \clist_map_inline:Nn \l_tmpa_clist 
    {
        \cs_gset_protected:cpn {#1} { \mathop{ \kern0pt \mathrm{#1} } }
    }
\ExplSyntaxOff

% \typeout{\Ext defined}
% \DeclareMathOperator\AAA{definition}

\RequirePackage{relsize}

\renewcommand{\theequation}{\arabic{chapter}.\arabic{section}.\arabic{definition}}

\renewcommand{\thedefinition}{\arabic{chapter}.\arabic{section}.\arabic{definition}}
\renewcommand{\theremark}{\arabic{chapter}.\arabic{section}.\arabic{definition}}
\renewcommand{\theexample}{\arabic{chapter}.\arabic{section}.\arabic{definition}}
\renewcommand{\thelemma}{\arabic{chapter}.\arabic{section}.\arabic{definition}}

\AtBeginEnvironment{example}{\protect\refstepcounter{definition}}
\AtBeginEnvironment{remark}{\protect\refstepcounter{definition}}
\AtBeginEnvironment{lemma}{\protect\refstepcounter{definition}}
\AtBeginEnvironment{equation}{\protect\refstepcounter{definition}}

\pretocmd{\section}{\setcounter{definition}{0}}


\newcommand{\cat}[1]{\mathsf{#1}}

\let\alias\let


\newcommand\mathbbpdf[1]{\special{pdf:literal 1 Tr 0.2 w}#1\special{pdf:literal 0 Tr 0 w}}

\newcounter{exercise}

\newcommand{\Exercises}{%
    \setcounter{exercise}{0}%
    \vskip0ex\kern4ex{\textbf{习题.}}%
}

\newcommand{\exercise}[1]{\refstepcounter{exercise}\vspace{.5em}\par\noindent{}习题\kern.5ex\theexercise.\kern.5em#1}

\def\theexercise{%
    \arabic{chapter}.\arabic{section}.\roman{exercise}
}




% 设置CJK字体
\setCJKmainfont{SourceHanSerifSC}[
    Path = C:/Users/angel/AppData/Local/Microsoft/Windows/Fonts/,
    Extension = .otf,
    UprightFont = *-Regular,
    BoldFont = *-Bold,
    ItalicFont = SIMKAI,
    BoldItalicFont = SIMKAI,
    AutoFakeBold = true,
    BoldFeatures = {FakeBold=1.5},
    ItalicFeatures = {
        Path = C:/Windows/Fonts/,
        Extension = .ttf,
    },
    BoldItalicFeatures = {
        Path = C:/Windows/Fonts/,
        Extension = .ttf,
        FakeBold=1.8
    }
]

% 设置等宽字体（用于代码等）
\setmonofont{JetBrainsMono-Regular}[
    Path = C:/Users/angel/AppData/Local/Microsoft/Windows/Fonts/,
    Scale = 0.9
]
% \setmainfont{Computer Modern Serif}

\RequirePackage{titlesec}

% 简单居中
\titleformat{\section}{\centering\Large\bfseries}{\thesection}{1em}{}

\newcommand{\op}{^{\rm op}}